// login.js

// Updated API_BASE_URL to point to the correct endpoint
const API_BASE_URL = 'http://10.171.191.73:8000';

document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Changed 'email' to 'username' to match the input field in login.html
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const rememberMe = document.getElementById('remember-me').checked;
    const submitBtn = form.querySelector('button[type="submit"]');

    // Clear previous errors
    document.querySelectorAll('.error-message').forEach(el => el.remove());

    // Loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="animate-spin">⚙️</span> Signing in...';

    // For demo/testing, using username and password
    if ((username === 'demouser' || username === 'testuser') && password === '123456') {
      const fakeToken = 'demo-token-12345';
      if (rememberMe) {
        localStorage.setItem('access_token', fakeToken);
        localStorage.setItem('refresh_token', 'demo-refresh-token');
      } else {
        sessionStorage.setItem('access_token', fakeToken);
      }
      localStorage.setItem('user', JSON.stringify({ username, name: 'Demo User' }));

      // Corrected redirect path to your main app page
      window.location.href = 'frontend.html';
      return;
    }

    // Real API call for login
    try {
      const response = await fetch(`${API_BASE_URL}/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        // Changed 'email' to 'username' in the body to match your FastAPI endpoint
        body: JSON.stringify({ username, password, remember_me: rememberMe }),
      });

      const data = await response.json();

      if (response.ok) {
        if (rememberMe) {
          localStorage.setItem('access_token', data.access_token);
          localStorage.setItem('refresh_token', data.refresh_token);
        } else {
          sessionStorage.setItem('access_token', data.access_token);
        }

        localStorage.setItem('user', JSON.stringify(data.user));
        // Corrected redirect path to your main app page
        window.location.href = 'frontend.html';
      } else {
        // Show API error message
        showError(form, data.message || 'Login failed.');
      }
    } catch (error) {
      showError(form, 'Network error. Please try again later.');
      console.error('Login error:', error);
    }
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<span>Sign in</span>';
  });

  function showError(form, message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message mt-4 p-3 bg-red-50 text-red-700 rounded-md text-sm';
    errorDiv.textContent = message;
    form.insertBefore(errorDiv, form.firstChild);
  }
});
